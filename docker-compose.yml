version: '3.8'

services:
  telegram-app-db:
    restart: always
    container_name: telegram-app-db
    image: postgres:13.4-alpine
    volumes:
      - pg-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: authusr
      POSTGRES_PASSWORD: auth123
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_DB: telegram-app
      WAIT_FOR_DB: 'true'
    ports:
      - 5432:${DB_PORT:-5432}
    networks:
      - app-net

  telegram-app:
    restart: unless-stopped
    container_name: telegram-app
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=${ENV:-development}
    depends_on:
      redis:
        condition: service_healthy
      telegram-app-db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "yarn", "run", "healthcheck" ]
      interval: 60s
      timeout: 5s
      retries: 10
    ports:
      - '${APP_PORT:-3000}:${APP_PORT:-3000}'
    networks:
      - app-net

  nginx-pgadmin:
    image: laurentbel/nginx-basic-auth
    ports:
      - "5050:80"
    depends_on:
      - pgadmin
    environment:
      - FORWARD_HOST=pgadmin
      - FORWARD_PORT=80
      - BASIC_USERNAME=${DB_BASIC_AUTH_LOGIN}
      - BASIC_PASSWORD=${DB_BASIC_AUTH_PASSWORD}
    networks:
      - app-net

  pgadmin:
    restart: unless-stopped
    container_name: telegram-app-pgadmin
    image: dpage/pgadmin4
    environment:
      PGADMIN_CONFIG_SERVER_MODE: 'False' # True if we use PGADMIN_DEFAULT_EMAIL and PGADMIN_DEFAULT_PASSWORD
      PGADMIN_DEFAULT_EMAIL: 'admin@example.com'
      PGADMIN_DEFAULT_PASSWORD: 'supersecret'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin:/var/lib/pgadmin
    networks:
      - app-net

  redis:
    restart: unless-stopped
    container_name: telegram-app-redis
    image: redis:6.2-alpine
    ports:
      - ${REDIS_PORT:-6379}:6379
    command: [ "redis-server", "--appendonly", "no", "--save", "" ]
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 600s
      timeout: 10s
      retries: 10
    networks:
      - app-net

  bullboard:
    restart: unless-stopped
    container_name: telegram-app-bullboard
    image: deadly0/bull-board
    ports:
      - ${BULL_BOARD_PORT:-6380}:3000
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - redis
      - telegram-app
    networks:
      - app-net

networks:
  app-net:
    name: app-net

volumes:
  pg-data: #driver: local
  pgadmin:
